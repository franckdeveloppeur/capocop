# Configuration Render pour Capocop
# Documentation: https://render.com/docs/infrastructure-as-code

services:
  # Application Web Laravel
  - type: web
    name: capocop-app
    runtime: docker
    dockerfilePath: ./Dockerfile.render
    plan: starter  # Changez en 'standard' ou 'pro' selon vos besoins
    region: frankfurt  # ou 'oregon', 'singapore', etc.
    branch: main  # Branche Git à déployer
    healthCheckPath: /
    numInstances: 1
    envVars:
      - key: APP_NAME
        value: Capocop
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: false
      - key: APP_KEY
        generateValue: true  # Render génère automatiquement
      - key: APP_URL
        sync: false  # À définir après le déploiement
      - key: APP_TIMEZONE
        value: UTC
      - key: APP_LOCALE
        value: fr
      - key: LOG_CHANNEL
        value: stack
      - key: LOG_LEVEL
        value: error
      
      # Base de données (MySQL externe)
      - key: DB_CONNECTION
        value: mysql
      - key: DB_HOST
        fromDatabase:
          name: capocop-db
          property: host
      - key: DB_PORT
        fromDatabase:
          name: capocop-db
          property: port
      - key: DB_DATABASE
        fromDatabase:
          name: capocop-db
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: capocop-db
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: capocop-db
          property: password
      
      # Redis Cache
      - key: CACHE_DRIVER
        value: redis
      - key: SESSION_DRIVER
        value: redis
      - key: QUEUE_CONNECTION
        value: redis
      - key: REDIS_HOST
        fromService:
          type: redis
          name: capocop-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: capocop-redis
          property: port
      - key: REDIS_PASSWORD
        fromService:
          type: redis
          name: capocop-redis
          property: connectionString
      
      # Filesystem
      - key: FILESYSTEM_DISK
        value: public
      
      # Mail
      - key: MAIL_MAILER
        value: smtp
      - key: MAIL_HOST
        sync: false
      - key: MAIL_PORT
        value: "587"
      - key: MAIL_USERNAME
        sync: false
      - key: MAIL_PASSWORD
        sync: false
      - key: MAIL_ENCRYPTION
        value: tls
      - key: MAIL_FROM_ADDRESS
        value: hello@capocop.com
      - key: MAIL_FROM_NAME
        value: Capocop
      
      # Sanctum
      - key: SANCTUM_STATEFUL_DOMAINS
        sync: false  # À définir avec votre domaine
    
    # Scaling automatique (optionnel)
    autoDeploy: true
    
    # Disque persistant pour storage
    disk:
      name: storage
      mountPath: /var/www/storage
      sizeGB: 10

  # Worker pour les queues
  - type: worker
    name: capocop-worker
    runtime: docker
    dockerfilePath: ./Dockerfile.render
    dockerCommand: php artisan queue:work --tries=3 --timeout=90 --sleep=3
    plan: starter
    region: frankfurt
    branch: main
    envVars:
      # Hérite des mêmes variables que le service web
      - fromGroup: capocop-env
    autoDeploy: true

  # Cron Jobs (tâches planifiées Laravel)
  - type: cron
    name: capocop-scheduler
    runtime: docker
    dockerfilePath: ./Dockerfile.render
    schedule: "* * * * *"  # Toutes les minutes
    dockerCommand: php artisan schedule:run
    region: frankfurt
    branch: main
    envVars:
      - fromGroup: capocop-env
    autoDeploy: true

# Base de données MySQL
databases:
  - name: capocop-db
    databaseName: capocop
    plan: starter  # ou 'standard' pour plus de performance
    region: frankfurt
    ipAllowList: []  # Vide = accessible depuis tous les services Render

# Redis pour cache et queues
redis:
  - name: capocop-redis
    plan: starter  # ou 'standard' pour plus de mémoire
    region: frankfurt
    maxmemoryPolicy: allkeys-lru  # Stratégie d'éviction
    ipAllowList: []



